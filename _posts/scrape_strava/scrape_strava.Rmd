---
title: "Strava Data"
description: |
  Arcticle on how to effectively scrape and store Strava data
author:
  - name: Julian During
    url: www.datannery.com
date: "`r Sys.Date()`"
output: distill::distill_article
---

I am a vivid runner and cyclist. Since a few years, I'm recording almost all
my activities with some kind of GPS device.

I record my runs with a Garmin device and my bike rides with a Wahoo 
device. Both accounts get synchronized with my Strava account. I figured
that it would be nice to directly access my data from my Strava account.

In the following text, I will describe the
progress to get the data into R. Once available in a nice format in R, the data
is stored as a pin in a private github repository. By doing so, the data is
easily accessible in other analysis or shiny apps.

```{r setup, include=FALSE}
pin_home_path <- paste0(fs::path_dir(here::here()), "/pin_strava")
pin_fun_path <- paste0(pin_home_path, "/R")
rava_home_path <- paste0(fs::path_dir(here::here()), "/rava")
rava_fun_path <- paste0(rava_home_path, "/R")

source(paste0(pin_fun_path, "/libraries.R"))

code_fun <- dir_ls(c(pin_fun_path, rava_fun_path)) %>% 
  map(read_lines) %>% 
  map(~ str_subset(.x, "^#'", negate = TRUE))

walk2(
  code_fun, path_ext_remove(path_file(names(code_fun))),
  ~ knitr::read_chunk(lines = .x, labels = .y))
```

In this analysis, the following packages are used:

```{r libraries, eval=FALSE}
```

The `rava` package is a package with helper functions regarding Strava data. It
can be installed via the following command:

```{r, eval=FALSE}
remotes::install_github("duju211/rava")
```


# Data

To get access to your Strava data from R, you have to create a Strava api.
How to do this is
documented [here](https://developers.strava.com/docs/getting-started/).

## OAuth Dance from R

The Strava api requires a so called OAuth dance. How this
can be done from within R is described in the following section.

Create an OAuth Strava app:

```{r define_strava_app}
```

You can find your `STRAVA_KEY` and `STRAVA_SECRET` variables under the Strava 
api settings after you have created your own personal api. The name of api is
determined during creation. In my case I named it `r_api`.

```{r}
my_app <- define_strava_app()
```

Define an endpoint:

```{r define_strava_endpoint}
```

The `authorize` parameter describes the url to send client to for authorization.
And the `access` argument is used to exchange the authenticated token.

```{r}
my_endpoint <- define_strava_endpoint()
```

The final authentication step. Before the user can execute the following steps,
he has to authenticate the api in the web browser.

```{r define_strava_sig}
```

```{r eval=FALSE}
my_sig <- define_strava_sig(my_app, my_endpoint)
```

The information in `my_sig` can now be used to access Strava data.

## Activities

We are now authenticated and can directly access Strava data.
At first load an overview table of all available activities 
(one activity per row). 
Because the total number of activities is unknown, use a while loop.
Break the execution of the loop, if there are no more activities to read.

```{r read_all_activities}
```

```{r, eval=FALSE}
df_act_raw <- read_all_activities(my_sig)
df_act_raw
```

```{r echo=FALSE}
readd(df_act_raw, path = paste0(pin_home_path, "/.drake"))
```

Determine activities, that were already scraped:

```{r existing_activities}
```

```{r, eval=FALSE}
df_existing_act <- existing_activities(board_name)
```

Pin all activities to a private github repository:

```{r pin_new_activities}
```

```{r, eval=FALSE}
pin_new_activities(df_act)
```

## Measurements

Read the ‘stream’ data from Strava.
A ‘stream’ is a nested list (json format) with all available measurements
of the corresponding activity.

To get all available variables and turn the result into a data frame, 
define a helper function. This function takes an id of an activity and
an authentication token, which we have created earlier.

```{r read_activity_stream}
```

Extract the measurements for each new activity and pin the result to the
repository:

```{r pin_new_rides}
```

Download all measurement data from the repository and combine in one big data
frame:

```{r act_meas}
```

```{r, eval=FALSE}
df_act_meas_nested <- read_meas_nested(df_act_ids)
df_act_meas <- unnest(df_act_meas_nested, meas)
df_act_meas
```

```{r, include=FALSE}
loadd(df_act_meas, path = paste0(pin_home_path, "/.drake"))
loadd(df_act, path = paste0(pin_home_path, "/.drake"))
```

```{r}
df_act_meas %>%
  select(-name)
```


# Visualisation

Visualize the final data. Every facet is a activity and the color represents the
type.


```{r}
df_act_meas %>%
  filter(!is.na(lat)) %>%
  ggplot(aes(x = lng, y = lat)) +
    geom_path() +
    facet_wrap(~ name, scales = "free") +
    theme(
      axis.line = element_blank(),
      axis.text.x = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      legend.position = "bottom",
      panel.background = element_blank(),
      panel.border = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      plot.background = element_blank(),
      strip.text = element_blank())
```